function saveAuthToken(e){const t=(new Date).getTime()+864e5;localStorage.setItem("authToken",e),localStorage.setItem("authTokenExpiry",t)}function getAuthToken(){const e=localStorage.getItem("authToken"),t=localStorage.getItem("authTokenExpiry");return e&&t?(new Date).getTime()>parseInt(t)?(localStorage.removeItem("authToken"),localStorage.removeItem("authTokenExpiry"),null):e:null}function showMessage(e,t,o=!1){const n=document.getElementById(e);n.className="message "+(o?"error":"success"),n.textContent=t}function showGlobalMessage(e,t=!1){showMessage("message",e,t),setTimeout((()=>{const e=document.getElementById("message");e.textContent="",e.className="message"}),3e3)}function initializeTokenHandling(e){document.addEventListener("DOMContentLoaded",(()=>{const t=getAuthToken();t&&(document.getElementById(e).value=t)})),document.getElementById(e).addEventListener("change",(e=>{e.target.value?saveAuthToken(e.target.value):(localStorage.removeItem("authToken"),localStorage.removeItem("authTokenExpiry"))}))}async function makeAuthenticatedRequest(e,t={}){const o=t.tokenId||"authToken",n=document.getElementById(o).value;if(!n)return showGlobalMessage("请输入 AUTH_TOKEN",!0),null;const r={method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}};try{const o=await fetch(e,{...r,...t});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return await o.json()}catch(e){return showGlobalMessage(`请求失败: ${e.message}`,!0),null}}function parseBooleanFromString(e,t=null){if("string"!=typeof e)return t;const o=e.toLowerCase().trim();return"true"===o||"1"===o||"false"!==o&&"0"!==o&&t}function parseStringFromBoolean(e,t=null){return"boolean"!=typeof e?t:e?"true":"false"}function parsePrompt(e){if(!e)return[];const t=[],o=e.split("\n");let n="",r="";const a={BEGIN_SYSTEM:"system",BEGIN_USER:"user",BEGIN_ASSISTANT:"assistant"};for(let e=0;e<o.length;e++){const s=o[e];let l=!1;for(const[e,o]of Object.entries(a))if(s.includes(e)){n&&r.trim()&&t.push({role:n,content:r.trim()}),n=o,r="",l=!0;break}l||s.includes("END_")||(r+=s+"\n")}return n&&r.trim()&&t.push({role:n,content:r.trim()}),t}function formatPromptToTable(e){if(!e||0===e.length)return"<p>无对话内容</p>";const t={system:"系统",user:"用户",assistant:"助手"};return`<table class="message-table"><thead><tr><th>角色</th><th>内容</th></tr></thead><tbody>${e.map((e=>{return`<tr><td>${t[e.role]||e.role}</td><td>${(o=e.content,o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")).replace(/\n/g,"<br>")}</td></tr>`;var o})).join("")}</tbody></table>`}function showPromptModal(e){try{const t=document.getElementById("promptModal"),o=document.getElementById("promptContent");if(!t||!o)return void console.error("Modal elements not found");const n=parsePrompt(e);o.innerHTML=formatPromptToTable(n),t.style.display="block"}catch(t){console.error("显示prompt对话框失败:",t),console.error("原始prompt:",e)}}