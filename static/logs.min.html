<!DOCTYPE html><html lang="zh"><meta charset="UTF-8"><link rel="icon" type="image/x-icon" href="data:image/x-icon;,"><meta name="viewport" content="width=device-width,initial-scale=1"><title>请求日志查看</title><link rel="stylesheet" href="/static/shared-styles.css"><script src="/static/shared.js"></script><style>.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:var(--spacing)}.stat-card{background:var(--card-background);padding:20px;border-radius:var(--border-radius);box-shadow:0 2px 8px rgba(0,0,0,.08);transition:all var(--transition-fast);border:1px solid var(--border-color)}.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.12)}.stat-card h4{margin:0 0 8px 0;color:var(--primary-color)}.stat-value{font-size:28px;font-weight:600;color:var(--primary-color);margin-top:4px}.refresh-container{display:flex;justify-content:space-between;align-items:center}.auto-refresh{display:flex;align-items:center;gap:8px;background:var(--card-background);padding:8px 16px;border-radius:var(--border-radius);border:1px solid var(--border-color)}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.4);overflow-y:hidden}.modal-content{background-color:var(--card-background);margin:5% auto;padding:20px;border-radius:var(--border-radius);width:90%;max-width:800px;max-height:85vh;overflow-y:auto;border:1px solid var(--border-color);box-shadow:0 8px 24px rgba(0,0,0,.15)}.close{float:right;cursor:pointer;font-size:28px}.info-button{padding:6px 12px;font-size:14px;border-radius:var(--border-radius);transition:all var(--transition-fast);background:var(--primary-color-alpha);color:var(--primary-color);border:1px solid var(--primary-color)}.info-button:hover{background:var(--primary-color);color:#fff}.message-table{width:100%;border-collapse:collapse;margin-top:10px;margin:0;border:1px solid var(--border-color)}.message-table td,.message-table th{padding:12px 16px;border-bottom:1px solid var(--border-color);transition:background-color var(--transition-fast)}.message-table td{word-break:break-word}.message-table td:nth-child(2){max-width:600px}.message-table td:first-child{width:80px;white-space:nowrap}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.modal-header h3{margin:0}.close{font-size:24px;font-weight:700;cursor:pointer;padding:5px 10px}.close:hover{color:var(--primary-color)}.usage-progress-container{margin:16px 0;height:8px;background-color:var(--border-color);border-radius:4px;overflow:hidden}.usage-progress-bar{height:100%;width:0%;transition:width .3s ease;background-color:var(--primary-color);border-radius:4px}.usage-progress-bar.low{background-color:#4caf50}.usage-progress-bar.medium{background-color:#ff9800}.usage-progress-bar.high{background-color:#f44336}.token-info-tooltip{position:relative;display:inline-block}.token-info-tooltip .tooltip-content{visibility:hidden;position:absolute;z-index:1002;background-color:var(--card-background);padding:12px 15px;border-radius:var(--border-radius);box-shadow:0 4px 16px rgba(0,0,0,.15);width:280px;left:50%;transform:translateX(-50%);bottom:calc(100% + 8px);opacity:0;transition:opacity .3s,visibility .3s;text-align:left;line-height:1.6;border:1px solid var(--border-color);pointer-events:none}.token-info-tooltip:hover .tooltip-content{visibility:visible;opacity:1}.token-info-tooltip .tooltip-content::after{content:'';position:absolute;top:100%;left:50%;margin-left:-8px;border-width:8px;border-style:solid;border-color:var(--card-background) transparent transparent transparent}.token-info-tooltip::after{content:'';position:absolute;left:50%;transform:translateX(-50%);bottom:100%;width:100%;height:10px;background:0 0}.token-info-tooltip .tooltip-info-row{display:flex;justify-content:space-between;margin:2px 0}.token-info-tooltip .tooltip-info-row .label{color:var(--text-secondary);margin-right:10px}.token-info-tooltip .tooltip-info-row .value{font-weight:500;word-break:break-word}.prompt-preview .tooltip-content{width:320px;max-height:200px;overflow-y:auto;overflow-x:hidden;white-space:pre-wrap;word-break:break-word}.prompt-preview .tooltip-content .message-meta{font-size:.8em;color:var(--text-secondary);padding:0;margin:0 0 4px 0}.prompt-preview .tooltip-content .last-message{font-size:.9em;line-height:1.5;color:var(--text-primary);margin:0;padding:0;white-space:pre-wrap;word-break:break-word}.prompt-preview .tooltip-content::-webkit-scrollbar{width:6px}.prompt-preview .tooltip-content::-webkit-scrollbar-thumb{background-color:var(--border-color);border-radius:3px}.prompt-preview .tooltip-content::-webkit-scrollbar-track{background-color:var(--card-background)}.table-container{border-radius:var(--border-radius);overflow:hidden;border:1px solid var(--border-color)}#logsTable{position:relative;z-index:1}#logsTable th{position:sticky;top:0;z-index:2;background:var(--primary-color);white-space:nowrap;transition:background-color .2s ease}#logsTable td{padding:12px 16px;border-bottom:1px solid var(--border-color);transition:background-color var(--transition-fast)}@media (max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr);gap:12px}.stat-card{padding:16px}.stat-value{font-size:24px}.modal-content{margin:2% auto;width:95%;padding:16px}}#logsTable tr:hover td{background-color:var(--hover-color,rgba(0,0,0,.02))}</style><h1>请求日志查看</h1><div class="container"><div class="form-group"><label>认证令牌:</label> <input type="password" id="authToken" placeholder="输入 AUTH_TOKEN"></div><div class="refresh-container"><div class="button-group"><button onclick="fetchLogs()">刷新日志</button></div><div class="auto-refresh"><input type="checkbox" id="autoRefresh" checked="checked"> <label for="autoRefresh">自动刷新 (60秒)</label></div></div></div><div class="container"><div class="stats-grid"><div class="stat-card"><h4>总请求数</h4><div id="totalRequests" class="stat-value">-</div></div><div class="stat-card"><h4>活跃请求数</h4><div id="activeRequests" class="stat-value">-</div></div><div class="stat-card"><h4>错误请求数</h4><div id="errorRequests" class="stat-value">-</div></div><div class="stat-card"><h4>最后更新</h4><div id="lastUpdate" class="stat-value">-</div></div></div><div class="table-container"><table id="logsTable"><thead><tr><th>序<th>时间<th>模型<th>Token信息<th>Prompt<th>用时/首字<th>流式响应<th>状态<th>错误信息<tbody id="logsBody"></table></div></div><div id="message"></div><div id="tokenModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Token 详细信息</h3><span class="close">&times;</span></div><table class="message-table"><tr><td>Token:<td id="modalToken"><tr><td>校验和:<td id="modalChecksum"><tr><td colspan="2" style="text-align:center;font-weight:700;background-color:var(--border-color)">用户信息<tr><td>邮箱:<td id="modalEmail"><tr><td>用户名:<td id="modalName"><tr><td>用户ID:<td id="modalId"><tr><td>更新时间:<td id="modalUpdatedAt"><tr><td colspan="2" style="text-align:center;font-weight:700;background-color:var(--border-color)">会员信息<tr><td>会员类型:<td id="modalMemberType"><tr><td>支付ID:<td id="modalPaymentId"><tr><td>试用剩余:<td id="modalTrialDays"><tr><td colspan="2" style="text-align:center;font-weight:700;background-color:var(--border-color)">使用量统计 (最近30天)<tr><td>Premium models:<td id="modalPremiumUsage"><tr><td>Standard models:<td id="modalStandardUsage"><tr><td>Unknown models:<td id="modalUnknownUsage"></table><div id="usageProgressContainer"></div></div></div><div id="promptModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>对话内容</h3><span class="close">&times;</span></div><div id="promptContent"></div></div></div><script>let refreshInterval;function updateStats(e){document.getElementById("totalRequests").textContent=e.total||0,document.getElementById("activeRequests").textContent=e.active||0,e.error?(document.getElementById("errorRequests").textContent=e.error,document.getElementById("errorRequests").parentElement.style.display=""):document.getElementById("errorRequests").parentElement.style.display="none",document.getElementById("lastUpdate").textContent=new Date(e.timestamp).toLocaleTimeString()}function getProgressBarClass(e){return e<=60?"low":e<=85?"medium":"high"}function formatMembershipType(e){if(!e)return"-";switch(e){case"free_trial":return"Pro Trial";case"pro":return"Pro";case"free":return"Free";case"enterprise":return"Enterprise";default:return e.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}}function showTokenModal(e){const t=document.getElementById("tokenModal");if(document.getElementById("modalToken").textContent=e.token||"-",document.getElementById("modalChecksum").textContent=e.checksum||"-",e.profile){const{user:t,stripe:n,usage:o}=e.profile;document.getElementById("modalEmail").textContent=t.email||"-",document.getElementById("modalName").textContent=t.name||"-",document.getElementById("modalId").textContent=t.id||"-",document.getElementById("modalUpdatedAt").textContent=t.updated_at?new Date(t.updated_at).toLocaleString():"-",document.getElementById("modalMemberType").textContent=formatMembershipType(n.membership_type),document.getElementById("modalPaymentId").textContent=n.payment_id||"-",document.getElementById("modalTrialDays").textContent=n.days_remaining_on_trial>0?`${n.days_remaining_on_trial}天`:"-";const a=document.getElementById("usageProgressContainer");a.innerHTML="";const r={modalPremiumUsage:o.premium,modalStandardUsage:o.standard,modalUnknownUsage:o.unknown};Object.entries(r).forEach((([e,t])=>{const n=document.getElementById(e);if(t){const{requests:e,tokens:o,max_requests:r}=t;if(r){const t=(e/r*100).toFixed(1);n.textContent=`${e}/${r} requests (${t}%), ${o} tokens`;const s=document.createElement("div");s.className="usage-progress-container";const d=getProgressBarClass(parseFloat(t));s.innerHTML=`<div class="usage-progress-bar ${d}" style="width: ${t}%"></div>`,a.appendChild(s)}else n.textContent=`${e} requests, ${o} tokens`}else n.textContent="-"}))}else["modalEmail","modalName","modalId","modalUpdatedAt","modalMemberType","modalPaymentId","modalTrialDays","modalPremiumUsage","modalStandardUsage","modalUnknownUsage"].forEach((e=>document.getElementById(e).textContent="-")),document.getElementById("usageProgressContainer").innerHTML="";t.style.display="block"}function formatSimpleTokenInfo(e){if(!e.profile)return"无用户信息";const{user:t,stripe:n,usage:o}=e.profile,a=o.premium?`${o.premium.requests}/${o.premium.max_requests}`:"-";return[["邮箱",t.email||"-"],...t.name?[["用户名",t.name]]:[],["会员",formatMembershipType(n.membership_type)],["Premium",a]].map((([e,t])=>`<div class="tooltip-info-row"><span class="label">${e}:</span><span class="value">${t}</span></div>`)).join("")}function updateTable(e){const t=document.getElementById("logsBody");updateStats(e),t.innerHTML=e.logs.map((e=>`<tr><td>${e.id}</td><td>${new Date(e.timestamp).toLocaleString()}</td><td>${e.model}</td><td><div class="token-info-tooltip"><button class="info-button" onclick='showTokenModal(${JSON.stringify(e.token_info)})'>查看详情<div class="tooltip-content">${formatSimpleTokenInfo(e.token_info)}</div></button></div></td><td>${e.prompt?`<div class="token-info-tooltip prompt-preview"><button class="info-button" onclick="showPromptModal(decodeURIComponent('${encodeURIComponent(e.prompt).replace(/'/g,"\\'")}'))">查看对话<div class="tooltip-content">${formatPromptPreview(e.prompt)}</div></button></div>`:"-"}</td><td>${formatTiming(e.timing.total,e.timing.first)}</td><td>${e.stream?"是":"否"}</td><td>${e.status}</td><td>${e.error||"-"}</td></tr>`)).join("")}function formatTiming(e,t){return`${e.toFixed(2)}s / ${null!=t?`${t.toFixed(2)}s`:"-"}`}function formatPromptPreview(e){try{const t=parsePrompt(e);if(!t||0===t.length)return"无对话内容";const n=t[t.length-1];return`<div class="message-meta">最后一条消息 (${{system:"系统",user:"用户",assistant:"助手"}[n.role]||n.role}):</div><div class="last-message">${n.content.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}</div>`}catch(e){return console.error("预览对话内容失败:",e),"无法解析对话内容"}}async function fetchLogs(){const e=await makeAuthenticatedRequest("/logs");e&&(updateTable(e),showGlobalMessage("日志获取成功"))}document.getElementById("autoRefresh").addEventListener("change",(function(e){e.target.checked?refreshInterval=setInterval(fetchLogs,6e4):clearInterval(refreshInterval)})),document.addEventListener("DOMContentLoaded",(()=>{const e=getAuthToken();e&&(document.getElementById("authToken").value=e,fetchLogs()),refreshInterval=setInterval(fetchLogs,6e4)})),initializeTokenHandling("authToken"),window.addEventListener("beforeunload",(()=>{refreshInterval&&clearInterval(refreshInterval)})),document.querySelectorAll(".modal .close").forEach((e=>{e.onclick=function(){this.closest(".modal").style.display="none"}})),window.onclick=function(e){e.target.classList.contains("modal")&&(e.target.style.display="none")}</script>