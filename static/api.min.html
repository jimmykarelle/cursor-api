<!DOCTYPE html><html lang="zh"><meta charset="UTF-8"><link rel="icon" type="image/x-icon" href="data:image/x-icon;,"><meta name="viewport" content="width=device-width,initial-scale=1"><title>API 管理</title><link rel="stylesheet" href="/static/shared-styles.css"><script src="/static/shared.js"></script><style>.status-healthy{color:var(--success-color);animation:pulse 2s infinite}.status-error{color:var(--error-color)}@keyframes pulse{0%{opacity:1}50%{opacity:.6}100%{opacity:1}}.footer{margin-top:2rem;color:var(--text-secondary);font-size:.9rem;text-align:center}.copy-button{position:absolute;right:0;top:0;padding:4px;background:0 0;min-height:auto}.model-input-container{position:relative}.custom-suffix{margin-top:1rem}.progress-container{margin-top:1rem}.usage-progress-container{width:100%;height:8px;background:var(--border-color);border-radius:4px;margin:8px 0;overflow:hidden}.usage-progress-bar{height:100%;transition:width .3s ease}.progress-low{background:var(--success-color)}.progress-medium{background:#ffa726}.progress-high{background:var(--error-color)}.usage-progress-bar.unlimited{background:repeating-linear-gradient(45deg,var(--success-color),var(--success-color) 10px,transparent 10px,transparent 20px);opacity:.5}@media (max-width:768px){.copy-button{width:auto!important}}</style><div class="container"><div style="display:flex;justify-content:space-between;align-items:center"><h1>API 管理</h1><div id="serverStatus" class="status-healthy">Healthy</div></div><div class="form-group"><label for="authToken">AUTH Token</label> <input id="authToken" placeholder="请输入 AUTH Token"></div><div class="button-group"><button onclick="calibrateToken()">校准 Token</button> <button onclick="getUserInfo()">获取用户信息</button> <button onclick="getModels()">获取模型列表</button></div><div class="form-group model-input-container"><label for="modelList">模型列表</label> <input id="modelList" readonly="readonly"> <button class="copy-button" onclick="copyModelList()">📋</button></div><div class="form-group custom-suffix"><input type="checkbox" id="customSuffix" onchange="toggleCustomSuffix()"> <label for="customSuffix">添加自定义后缀</label> <input id="suffixInput" placeholder="@OpenAI" style="display:none"></div></div><div id="userInfoContainer" class="container" style="display:none"><h2>用户信息</h2><div id="userDetails"></div><div id="usageProgressContainer" class="progress-container"></div></div><div id="message" class="message"></div><footer class="footer"><div id="version"></div><div id="uptime"></div></footer><script>let globalModels=[];const calibrationCache=new Map;async function checkServerStatus(){try{const e=await fetch("/health"),t=await e.json(),a=document.getElementById("serverStatus");return a.className="healthy"===t.status?"status-healthy":"status-error",a.textContent="healthy"===t.status?"Healthy":"Error",document.getElementById("version").textContent=`版本: ${t.version}`,document.getElementById("uptime").textContent=formatUptime(t.uptime),globalModels=t.models||[],!0}catch(e){const t=document.getElementById("serverStatus");return t.className="status-error",t.textContent="Error",showGlobalMessage("服务器状态检查失败",!0),!1}}function startStatusCheck(){checkServerStatus(),setInterval(checkServerStatus,3e5)}function formatUptime(e){return`运行时间: ${Math.floor(e/86400)}天 ${Math.floor(e%86400/3600)}时 ${Math.floor(e%3600/60)}分`}async function getModels(){const e=document.getElementById("modelList"),t=document.getElementById("customSuffix").checked?document.getElementById("suffixInput").value:"";e.value=globalModels.map((e=>e+t)).join(",")}function copyModelList(){const e=document.getElementById("modelList");navigator.clipboard.writeText(e.value).then((()=>showGlobalMessage("已复制到剪贴板"))).catch((()=>showGlobalMessage("复制失败",!0)))}function toggleCustomSuffix(){document.getElementById("suffixInput").style.display=document.getElementById("customSuffix").checked?"block":"none",document.getElementById("customSuffix").checked&&getModels()}async function makeTokenRequest(e,t){try{const a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return await a.json()}catch(e){return showGlobalMessage(`请求失败: ${e.message}`,!0),null}}async function calibrateToken(){const e=document.getElementById("authToken").value;if(!e)return void showGlobalMessage("请输入 AUTH Token",!0);const t=await makeTokenRequest("/basic-calibration",e);t&&("error"===t.status?showGlobalMessage(t.message,!0):(showGlobalMessage("校准成功"),calibrationCache.set(e,{user_id:t.user_id,create_at:t.create_at,checksum_time:calibResult.checksum_time}),updateUsageDisplay(null,calibrationCache.get(e))))}async function getUserInfo(){const e=document.getElementById("authToken").value;if(!e)return void showGlobalMessage("请输入 Token",!0);if(!calibrationCache.has(e)){const t=await makeTokenRequest("/basic-calibration",e);t&&"error"!==t.status&&calibrationCache.set(e,{user_id:t.user_id,create_at:t.create_at,checksum_time:t.checksum_time})}const t=await makeTokenRequest("/get-userinfo",e);if(t){document.getElementById("userInfoContainer").style.display="block",updateUsageDisplay(t,calibrationCache.get(e))}}function updateUsageDisplay(e,t){const a=document.getElementById("userDetails"),s=document.getElementById("usageProgressContainer");if(a.innerHTML="",s.innerHTML="",e.user||t){const s=e.user||{};a.innerHTML+=`<p>用户ID: ${t?t.user_id:s.id}</p><p>邮箱: ${s.email||""}</p><p>用户名: ${s.name||""}</p>${s.updated_at?`<p>更新时间: ${new Date(s.updated_at).toLocaleString()}</p>`:""}${t?`<p>令牌创建时间: ${new Date(t.create_at).toLocaleString()}</p>`:""}${t&&t.checksum_time?`<p>校验和时间区间: ${new Date(1e6*t.checksum_time).toLocaleString()} - ${new Date(1e6*(t.checksum_time+1)-1).toLocaleString()}</p>`:""}`}if(e.stripe){const t=e.stripe;a.innerHTML+=`<p>会员类型: ${t.membership_type}</p>${t.payment_id?`<p>付款 ID: ${t.payment_id}</p>`:""}<p>试用剩余: ${t.days_remaining_on_trial} 天</p>`}if(e.usage){const t=e.usage,a={"高级模型":t.premium,"标准模型":t.standard,"未知模型":t.unknown};Object.entries(a).forEach((([e,t])=>{if(t){const a=!t.max_requests,n=a?100:(t.requests/t.max_requests*100).toFixed(1),o=a?"unlimited":getProgressBarClass(parseFloat(n));s.innerHTML+=`<div><p>${e}: ${t.requests}/${a?"∞":t.max_requests} 请求 ${a?"":`(${n}%)`}, ${t.tokens} tokens</p>\n<div class="usage-progress-container"><div class="usage-progress-bar ${o}" style="width: ${n}%"></div></div></div>`}}))}}function getProgressBarClass(e){return e<50?"progress-low":e<80?"progress-medium":"progress-high"}document.getElementById("authToken").addEventListener("change",(e=>{calibrationCache.delete(e.target.value)})),document.addEventListener("DOMContentLoaded",(()=>{startStatusCheck(),document.getElementById("suffixInput").addEventListener("input",getModels)}))</script>